\chapter{Boundary tracing in curvilinear coordinates}
\label{ch:curvilinear}

The actual determination of the sought-after traced boundaries involves
recasting the flux boundary condition~(\ref{eq:flux-boundary-condition})
as a first-order ODE (or system of ODEs) for the traced boundaries.
In practice, the appropriate coordinate system and parametrisation
will depend on the geometry of the specific problem at hand.

Whilst Anderson~\etal~\cite{%
  anderson-2007-boundary-tracing-i-theory,%
  anderson-2007-boundary-tracing-ii-applications%
}
did not restrict themselves to Cartesian coordinates in analytical work,
the boundary tracing ODE was separately derived
for each new coordinate system encountered;
no generalised version was given.
As for numerical boundary tracing using arc-length parametrisation,
Anderson~\cite{anderson-2002-thesis-boundary-tracing-pdes}
only considered Cartesian coordinates.

In preparation for the various coordinate systems
which will be used in this thesis,
I derive in this chapter the boundary tracing ODE
and the corresponding system of ODEs for arc-length parametrisation,
with both applicable in any orthogonal coordinate system.

\section{Orthogonal curvilinear coordinates in 2D}
\label{sec:curvilinear.orthogonal}

First I go through some preliminary definitions and terminology.

Let~$(\basisvec{x}, \basisvec{y})$ be the standard basis vectors
of the usual Cartesian coordinates~$(x, y)$.
The \emph{position vector} is
\begin{equation}
  \positionvec \defeq x \basisvec{x} + y \basisvec{y},
  \label{eq:position-vector-cartesian}
\end{equation}
and since $\basisvec{x}$ and~$\basisvec{y}$ are globally constant,
observe that
\begin{align}
  \basisvec{x} &= \pder{\positionvec}{x},
    \label{eq:x-basis-vector} \\[\fraclinespace]
  \basisvec{y} &= \pder{\positionvec}{y}.
    \label{eq:y-basis-vector}
\end{align}
Now consider the \emph{curvilinear coordinates}~$(u, v)$
given by the transformation
\begin{align}
  x &= x (u, v), \label{eq:curvilinear-x-transformation} \\
  y &= y (u, v). \label{eq:curvilinear-y-transformation}
\end{align}
A \emph{local basis}~$(\localvec{u}, \localvec{v})$
arises from the derivatives of position
in analogy to~(\ref{eq:x-basis-vector}) and~(\ref{eq:y-basis-vector}),
\begin{align}
  \localvec{u} &
    \defeq \pder{\positionvec}{u}
    = \pder{x}{u} \basisvec{x} + \pder{y}{u} \basisvec{y},
      \label{eq:u-local-basis-vector} \\[\fraclinespace]
  \localvec{v} &
    \defeq \pder{\positionvec}{v}
    = \pder{x}{v} \basisvec{x} + \pder{y}{v} \basisvec{y}.
      \label{eq:v-local-basis-vector}
\end{align}
It is assumed that the curvilinear coordinates~$(u, v)$ are \emph{orthogonal},
meaning the local basis vectors are orthogonal to each other:
\begin{equation}
  \localvec{u} \dotp \localvec{v} = 0.
  \label{eq:local-basis-orthogonal}
\end{equation}
The magnitudes of the local basis vectors may not be unity;
in fact, should either~$u$ or~$v$ not have dimensions of length,
the corresponding local basis vector will not even be dimensionless.
Therefore, one defines the \emph{scale factors}
(or \emph{\lame{} coefficients})
\begin{align}
  \scalefac[u] &\defeq \norm{\localvec{u}}, \label{eq:u-scale-factor} \\
  \scalefac[v] &\defeq \norm{\localvec{v}}, \label{eq:v-scale-factor}
\end{align}
and then normalises the local basis
to obtain the \emph{local orthonormal basis},
\begin{align}
  \basisvec{u} &\defeq \frac{\localvec{u}}{\scalefac[u]},
      \label{eq:u-basis-vector} \\[\fraclinespace]
  \basisvec{v} &\defeq \frac{\localvec{v}}{\scalefac[v]},
      \label{eq:v-basis-vector}
\end{align}
for which
\begin{equation}
  \basisvec{u} \dotp \basisvec{v} = 0
  \label{eq:orthonormal-basis-orthogonal}
\end{equation}
and
\begin{equation}
  \norm{\basisvec{u}} = \norm{\basisvec{v}} = 1.
  \label{eq:orthonormal-basis-normalised}
\end{equation}

\section{Vector calculus}
\label{sec:curvilinear.calculus}

Next, I run through the mathematical machinery required
to do calculus in an orthogonal coordinate system.

\subsection{Differential displacement}
\label{sec:curvilinear.calculus.displacement}

Consider the $u$-contour and the $v$-contour through a point~$(u, v)$.
Independently incrementing~$u$ by~$\td u$ and~$v$ by~$\td v$
results in two new contours,
corresponding to each of the new coordinates.
Since the coordinate system is orthogonal,
the four contours (two old and two new)
shall mark out an infinitesimal rectangle,
aligned with the local orthonormal basis
and with sides of length~$\scalefac[u] \td u$ and~$\scalefac[v] \td v$.
Indeed the \emph{differential displacement} is
\begin{align*}
  \td \positionvec
  &\defeq
    \pder{\positionvec}{u} \td u + \pder{\positionvec}{v} \td v
    \\[\fraclinespace]
  &= \localvec{u} \td u + \localvec{v} \td v \\
  &= \scalefac[u] \td u \basisvec{u} + \scalefac[v] \td v \basisvec{v}.
    \yesnumber
    \label{eq:differential-displacement}
\end{align*}
The area of the infinitesimal rectangle is
the \emph{differential area element}
\begin{equation}
  \td V = \scalefac[u] \scalefac[v] \td u \td v.
  \label{eq:differential-area-element}
\end{equation}

\subsection{Gradient}
\label{sec:curvilinear.calculus.gradient}

Consider a scalar field~$T$
(which, in the context of boundary tracing, shall be the known solution).
By the chain rule, the independent increments~$\td u$ and~$\td v$
effect the differential change
\begin{align*}
  \td T
  &= \pder{T}{u} \td u + \pder{T}{v} \td v \\[\fraclinespace]
  &=
    \roundbr*{\frac{1}{\scalefac[u]} \pder{T}{u}}
    \roundbr[\big]{\scalefac[u] \td u}
      +
    \roundbr*{\frac{1}{\scalefac[v]} \pder{T}{v}}
    \roundbr[\big]{\scalefac[v] \td v}.
    \yesnumber
    \label{eq:scalar-differential-change}
\end{align*}
By the definition of gradient,
and using~(\ref{eq:differential-displacement}),
\begin{align*}
  \td T
  &\defeq \del T \dotp \td \positionvec \\
  &=
    \del T
      \dotp
    \roundbr[\big]{
      \scalefac[u] \td u \basisvec{u}
        +
      \scalefac[v] \td v \basisvec{v}
    }.
    \yesnumber
    \label{eq:scalar-differential-change-gradient}
\end{align*}
Comparing~(\ref{eq:scalar-differential-change})
and~(\ref{eq:scalar-differential-change-gradient}),
it follows that the \emph{gradient} of~$T$ is given by
\begin{equation}
  \del T =
    \frac{1}{\scalefac[u]} \pder{T}{u} \basisvec{u}
      +
    \frac{1}{\scalefac[v]} \pder{T}{v} \basisvec{v}.
  \label{eq:gradient}
\end{equation}

\subsection{Divergence}
\label{sec:curvilinear.calculus.divergence}

Consider a vector field~$%
\vec{E} = \comp{E}{u} \basisvec{u} + \comp{E}{v} \basisvec{v}$,
and the infinitesimal rectangle
of Section~\ref{sec:curvilinear.calculus.displacement},
whose sides are of length~$\scalefac[u] \td u$ and~$\scalefac[v] \td v$.

To first order,
the net flux across the two edges normal to~$\basisvec{u}$
(which have length~$\scalefac[v] \td v$) is
\[
  \pder{}{u} \roundbr[\Big]{
    \comp{E}{u} \cdot \scalefac[v] \td v
  } \cdot \td u,
\]
and the net flux across the two edges normal to~$\basisvec{v}$
(which have length~$\scalefac[u] \td u$) is
\[
  \pder{}{v} \roundbr[\Big]{
    \comp{E}{v} \cdot \scalefac[u] \td u
  } \cdot \td v.
\]
Summing these results in the flux across the entire perimeter of the rectangle,
which, divided by its area,
the area element~(\ref{eq:differential-area-element}),
yields the \emph{divergence} of~$\vec{E}$,
\begin{equation}
  \del \dotp \vec{E} =
    \frac{1}{\scalefac[u] \scalefac[v]}
    \squarebr*{
      \pder{}{u} \roundbr[\Big]{\scalefac[v] \comp{E}{u}}
        +
      \pder{}{v} \roundbr[\Big]{\scalefac[u] \comp{E}{v}}
    }.
  \label{eq:divergence}
\end{equation}

\subsection{Laplacian}
\label{sec:curvilinear.calculus.laplacian}

Composing the divergence~(\ref{eq:divergence})
and the gradient~(\ref{eq:gradient}) (with~$\vec{E} = \del T$),
it follows that the \emph{Laplacian} of~$T$ is given by
\begin{equation}
  \del^2 T \defeq \del \dotp \del T =
    \frac{1}{\scalefac[u] \scalefac[v]}
    \squarebr*{
      \pder{}{u} \roundbr*{\frac{\scalefac[v]}{\scalefac[u]} \pder{T}{u}}
        +
      \pder{}{v} \roundbr*{\frac{\scalefac[u]}{\scalefac[v]} \pder{T}{v}}
    }.
  \label{eq:laplacian}
\end{equation}
In particular,
if the two scale factors~$\scalefac[u]$ and~$\scalefac[v]$ are equal,
say~$\scalefac[u] = \scalefac[v] = \scalefac$,
this simplifies to
\begin{equation}
  \del^2 T =
    \frac{1}{\scalefac^2}
    \squarebr*{\pder[2]{T}{u} + \pder[2]{T}{v}}.
  \label{eq:laplacian-scale-factors-equal}
\end{equation}

\subsection{Boundary normal}
\label{sec:curvilinear.calculus.normal}

The \emph{tangent vector}~$\tangentvec$ to a curve
is given by the unit vector of
the differential displacement~(\ref{eq:differential-displacement}),
i.e.,
\begin{equation}
  \tangentvec =
    \frac{
      \scalefac[u] \td u \basisvec{u}
        +
      \scalefac[v] \td v \basisvec{v}
    }{
      \td s
    },
  \label{eq:tangent-vector}
\end{equation}
where $\td s$~is the \emph{differential arc length}
\begin{equation}
  \td s \defeq \norm{\td \positionvec} =
  \sqrt{
    \roundbr[\big]{\scalefac[u] \td u}^2
      +
    \roundbr[\big]{\scalefac[v] \td v}^2
  }.
  \label{eq:differential-arc-length}
\end{equation}
The normal vector~$\normalvec$ to a curve
is perpendicular to the tangent~$\tangentvec$;
therefore
\begin{equation}
  \normalvec =
    \frac{
      \scalefac[v] \td v \basisvec{u}
        -
      \scalefac[u] \td u \basisvec{v}
    }{
      \td s
    },
  \label{eq:normal-vector}
\end{equation}
up to sign.

\subsection{Abbreviations}
\label{sec:curvilinear.calculus.abbreviations}

Since the scale factors~$\scalefac[u]$ and~$\scalefac[v]$ appear regularly,
it is helpful to define abbreviations
before proceeding any further.

For the components of the differential displacement
vector~(\ref{eq:differential-displacement}),
which are the side lengths of the infinitesimal rectangle
of Section~\ref{sec:curvilinear.calculus.displacement},
let
\begin{align}
  \td \mu &\defeq \scalefac[u] \td u,
    \label{eq:differential-displacement-u-component} \\
  \td \nu &\defeq \scalefac[v] \td v,
    \label{eq:differential-displacement-v-component}
\end{align}
so that
\begin{equation}
  \td \positionvec = \td \mu \basisvec{u} + \td \nu \basisvec{v}
  \label{eq:differential-displacement-abbreviated}
\end{equation}
and
\begin{equation}
  \td s = \sqrt{{\td \mu}^2 + {\td \nu}^2}.
  \label{eq:differential-arc-length-abbreviated}
\end{equation}
For the components of the gradient vector~(\ref{eq:gradient}),
write
\begin{align}
  P &\defeq \frac{1}{\scalefac[u]} \pder{T}{u},
    \label{eq:gradient-u-component} \\[\fraclinespace]
  Q &\defeq \frac{1}{\scalefac[v]} \pder{T}{v},
    \label{eq:gradient-v-component}
\end{align}
so that
\begin{equation}
  \del T = P \basisvec{u} + Q \basisvec{v}.
  \label{eq:gradient-abbreviated}
\end{equation}
Finally, for the components of
the tangent vector~(\ref{eq:tangent-vector}), define
\begin{align}
  \alpha &\defeq \tder{\mu}{s} = \frac{\scalefac[u] \td u}{\td s},
    \label{eq:tangent-u-component} \\[\fraclinespace]
  \beta &\defeq \tder{\nu}{s} = \frac{\scalefac[v] \td v}{\td s},
    \label{eq:tangent-v-component}
\end{align}
so that
\begin{align}
  \tangentvec
  &= \frac{\td \mu \basisvec{u} + \td \nu \basisvec{v}}{\td s}
  = \alpha \basisvec{u} + \beta \basisvec{v},
    \label{eq:tangent-vector-abbreviated} \\[\fraclinespace]
  \normalvec
  &= \frac{\td \nu \basisvec{u} - \td \mu \basisvec{v}}{\td s}
  = \beta \basisvec{u} - \alpha \basisvec{v}.
    \label{eq:normal-vector-abbreviated}
\end{align}
Note that
\begin{align}
  P^2 + Q^2 &= (\del T)^2, \label{eq:gradient-pythagoras} \\
  \alpha^2 + \beta^2 &= 1. \label{eq:tangent-pythagoras}
\end{align}

\section{Boundary tracing ODE}
\label{sec:curvilinear.tracing}

With the workings of orthogonal curvilinear coordinates now established,
I derive in this section
the boundary tracing ODE for coordinate parametrisation
and the corresponding system of ODEs for arc-length parametrisation.
Recall that the sought-after traced boundaries are to satisfy
the boundary condition~(\ref{eq:flux-boundary-condition}),
in which $T$~is the chosen known solution (to the PDE under consideration)
and $F$~is the prescribed flux function.

It is convenient to define the \emph{viability function}
\begin{important}{equation}
  \Phi \defeq (\del T)^2 - F^2.
  \label{eq:viability-function}
\end{important}
This is not only algebriacally useful,
but also physically meaningful;
the viable domain is the region~$\Phi \ge 0$,
the non-viable domain, $\Phi < 0$,
and the terminal curve, $\Phi = 0$.

\subsection{Coordinate parametrisation}
\label{sec:curvilinear.tracing.coordinate}

Suppose the traced boundaries are to be parametrised
in the form~$v = v (u)$.
Using~(\ref{eq:normal-vector-abbreviated}),
(\ref{eq:differential-arc-length-abbreviated})
and~(\ref{eq:gradient-abbreviated}),
the boundary condition~(\ref{eq:flux-boundary-condition}) becomes
\[
  \frac{
    \td \nu \basisvec{u} - \td \mu \basisvec{v}
  }{
    \sqrt{{\td \mu}^2 + {\td \nu}^2}
  }
    \dotp
  \roundbr[\big]{P \basisvec{u} + Q \basisvec{v}}
    =
  F,
\]
which expands into the quadratic equation
\begin{equation}
  \roundbr*{P^2 - F^2} \, {\td \nu}^2
  - 2 P Q \td \nu \td \mu
  + \roundbr*{Q^2 - F^2} \, {\td \mu}^2
    =
  0.
  \label{eq:tracing-coordinate-parametrisation-quadratic}
\end{equation}
Solving this for~$\td \nu / \td \mu$ results in the boundary tracing ODE
\begin{equation}
  \tder{\nu}{\mu} = \frac{P Q \pm F \sqrt{\Phi}}{P^2 - F^2},
  \label{eq:tracing-ode-coordinate-parametrisation-nu}
\end{equation}
or
\begin{important}{equation}
  \tder{v}{u} =
    \frac{\scalefac[u]}{\scalefac[v]}
      \cdot
    \frac{P Q \pm F \sqrt{\Phi}}{P^2 - F^2}.
  \label{eq:tracing-ode-coordinate-parametrisation-v}
\end{important}
Alternatively, for the parametrisation~$u = u (v)$,
one solves for~$\td \mu / \td \nu$, giving
\begin{equation}
  \tder{\mu}{\nu} = \frac{P Q \mp F \sqrt{\Phi}}{Q^2 - F^2},
  \label{eq:tracing-ode-coordinate-parametrisation-mu}
\end{equation}
or
\begin{important}{equation}
  \tder{u}{v} =
    \frac{\scalefac[v]}{\scalefac[u]}
      \cdot
    \frac{P Q \mp F \sqrt{\Phi}}{Q^2 - F^2}.
  \label{eq:tracing-ode-coordinate-parametrisation-u}
\end{important}
In both cases, the two possible choices of sign
correspond to the two branches of traced boundaries
which exist in the viable domain.
Note also the occurrence of~$\sqrt{\Phi}$,
corresponding to the absence of traced boundaries
in the non-viable domain~$\Phi < 0$.

\subsection{Arc-length parametrisation}
\label{sec:curvilinear.tracing.arc-length}

In numerical boundary tracing,
the coordinate parametrisations~$v = v (u)$ and~$u = u (v)$
will be problematic
if~$\td v / \td u$ or~$\td u / \td v$ ever become infinite,
corresponding to traced boundaries
which are parallel to~$\basisvec{v}$ or~$\basisvec{u}$.

To avoid such singularities in numerical work, one should instead use
the arc-length parametrisation~$u = u (s)$, $v = v(s)$
to put the two coordinates~$u$ and~$v$ on an equal footing.
Using~(\ref{eq:normal-vector-abbreviated})
and~(\ref{eq:gradient-abbreviated}),
the boundary condition~(\ref{eq:flux-boundary-condition}) becomes
\[
  \roundbr[\big]{\beta \basisvec{u} - \alpha \basisvec{v}}
    \dotp
  \roundbr[\big]{P \basisvec{u} + Q \basisvec{v}}
    =
  F,
\]
which, along with the unit-speed condition~(\ref{eq:tangent-pythagoras}),
forms the system%
\footnote{
  This system is also given
  in Anderson's thesis~\cite{anderson-2002-thesis-boundary-tracing-pdes},
  but only in Cartesian coordinates.
  Moreover, Anderson passes the system directly to a numerical integrator
  without first solving for~$\alpha$ and~$\beta$,
  so that at every step of the integration,
  a numerical comparison with the previous root
  is required to select the correct root among the two possible.
  This ought not be done,
  given that the two branches may be separated analytically
  as per~(\ref{eq:tracing-ode-arc-length-parametrisation-mu})
  and~(\ref{eq:tracing-ode-arc-length-parametrisation-nu}).
}
\begin{align}
  P \beta - Q \alpha &= F,
    \label{eq:tracing-arc-length-parametrisation-flux-boundary-condition} \\
  \alpha^2 + \beta^2 &= 1.
    \label{eq:tracing-arc-length-parametrisation-unit-speed}
\end{align}
Solving~(\ref{eq:tracing-arc-length-parametrisation-flux-boundary-condition})
and~(\ref{eq:tracing-arc-length-parametrisation-unit-speed})
for~$\alpha$ and~$\beta$, one obtains
the boundary tracing system of ODEs under arc-length parametrisation,
\begin{align}
  \tder{\mu}{s} &\defeq \alpha = \frac{-Q F \pm P \sqrt{\Phi}}{(\del T)^2},
    \label{eq:tracing-ode-arc-length-parametrisation-mu} \\[\fraclinespace]
  \tder{\nu}{s} &\defeq \beta = \frac{\+P F \pm Q \sqrt{\Phi}}{(\del T)^2},
    \label{eq:tracing-ode-arc-length-parametrisation-nu}
\end{align}
or
\begin{important}{align}
  \tder{u}{s} &= \frac{-Q F \pm P \sqrt{\Phi}}{\scalefac[u] (\del T)^2},
    \label{eq:tracing-ode-arc-length-parametrisation-u} \\[\fraclinespace]
  \tder{v}{s} &= \frac{\+P F \pm Q \sqrt{\Phi}}{\scalefac[v] (\del T)^2}.
    \label{eq:tracing-ode-arc-length-parametrisation-v}
\end{important}
As was the case for coordinate parametrisation
(Section~\ref{sec:curvilinear.tracing.coordinate}),
notice the two possible choices of sign
(which correspond to the two branches of traced boundaries)
and the occurrences of~$\sqrt{\Phi}$
(which correspond to the absence of traced boundaries
in the non-viable domain~$\Phi < 0$).

\subsection{Arc-length parametrisation for contours}
\label{sec:curvilinear.tracing.arc-length-contours}

When classifying terminal points as either ordinary or critical
(and the critical cases thereof as hyperbolic, elliptic or degenerate),
it is useful to visualise the terminal curve (which is the contour~$\Phi = 0$)
and the contours of the known solution~$T$,
because it is the manner of their intersection,
i.e.~whether they cross or touch,
which determines this.

For numerical computation of contours,
arc-length parametrisation is again more robust
than coordinate parametrisation
(which is unable to handle singularities
in~$\td v / \td u$ and~$\td u / \td v$).
Suppose a $T$-contour is to be parametrised by arc length,
i.e.~$u = u (s)$, $v = v(s)$.
By definition, there holds
\[
  \td T \defeq \del T \dotp \td \positionvec = 0
\]
along the contour,
which, using~(\ref{eq:gradient-abbreviated})
and~(\ref{eq:differential-displacement-abbreviated}),
becomes
\[
  P \td \mu + Q \td \nu = 0,
\]
or
\begin{equation}
  P \alpha + Q \beta = 0.
  \label{eq:contour-arc-length-parametrisation-contour}
\end{equation}
Combining this with the unit-speed condition~(\ref{eq:tangent-pythagoras}),
the resulting system in~$\alpha$ and~$\beta$
solves to give the system of ODEs
\begin{align}
  \tder{\mu}{s} &\defeq \alpha = \frac{\pm Q}{\norm{\del T}},
    \label{eq:contour-ode-arc-length-parametrisation-mu} \\[\fraclinespace]
  \tder{\nu}{s} &\defeq \beta = \frac{\mp P}{\norm{\del T}}
    \label{eq:contour-ode-arc-length-parametrisation-nu},
\end{align}
or
\begin{important}{align}
  \tder{u}{s} &= \frac{\pm Q}{\scalefac[u] \norm{\del T}},
    \label{eq:contour-ode-arc-length-parametrisation-u} \\[\fraclinespace]
  \tder{v}{s} &= \frac{\mp P}{\scalefac[v] \norm{\del T}}
    \label{eq:contour-ode-arc-length-parametrisation-v},
\end{important}
for a $T$-contour.
If a $\Phi$-contour is instead sought
(such as for the terminal curve~$\Phi = 0$),
simply replace~$T$ with~$\Phi$
(including in the definitions~(\ref{eq:gradient-u-component})
and~(\ref{eq:gradient-v-component})
for the gradient components~$P$ and~$Q$).
